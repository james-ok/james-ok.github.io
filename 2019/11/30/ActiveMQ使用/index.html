<!DOCTYPE HTML>
<html lang="zh-CN">


<head><meta name="generator" content="Hexo 3.9.0">
    <meta charset="utf-8">
    <meta name="keywords" content="ActiveMQ使用, james-ok,github">
    <meta name="description" content="相信大家遇到过这样的场景，用户注册这个简单的功能里面集成了太多不是很重要步骤，但又不得不做。比如发送邮件、发放优惠券、发送推销短信、记录日志，这样就导致了我们注册功能特别繁重，极大的拉低了接口性能，给用户带来体验度大大降低，明明就一个注册用">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="renderer" content="webkit|ie-stand|ie-comp">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>ActiveMQ使用 | James</title>
    <link rel="icon" type="image/png" href="/favicon.png">

    <link rel="stylesheet" type="text/css" href="/libs/awesome/css/font-awesome.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/materialize/css/materialize.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/aos/aos.css">
    <link rel="stylesheet" type="text/css" href="/libs/animate/animate.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/lightGallery/css/lightgallery.min.css">
    <link rel="stylesheet" type="text/css" href="/css/matery.css">
    <link rel="stylesheet" type="text/css" href="/css/my.css">
    <style type="text/css">
        
        code[class*="language-"], pre[class*="language-"] {
            white-space: pre !important;
        }
        
    </style>

    <script src="/libs/jquery/jquery-2.2.0.min.js"></script>
<link rel="stylesheet" href="/css/prism-tomorrow.css" type="text/css">
<link rel="stylesheet" href="/css/prism-line-numbers.css" type="text/css"></head>


<body>

<header class="navbar-fixed">
    <nav id="headNav" class="bg-color nav-transparent">
        <div id="navContainer" class="container">
            <div class="nav-wrapper">
                <div class="brand-logo">
                    <a href="/" class="waves-effect waves-light">
                        
                        <img src="/medias/logo.png" class="logo-img hide-on-small-only">
                        
                        <span class="logo-span">James</span>
                    </a>
                </div>
                

<a href="#" data-activates="mobile-nav" class="button-collapse"><i class="fa fa-navicon"></i></a>
<ul class="right">
    
    <li class="hide-on-med-and-down">
        <a href="/" class="waves-effect waves-light">
            
            <i class="fa fa-home"></i>
            
            <span>首页</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/tags" class="waves-effect waves-light">
            
            <i class="fa fa-tags"></i>
            
            <span>标签</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/categories" class="waves-effect waves-light">
            
            <i class="fa fa-bookmark"></i>
            
            <span>分类</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/archives" class="waves-effect waves-light">
            
            <i class="fa fa-archive"></i>
            
            <span>归档</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/about" class="waves-effect waves-light">
            
            <i class="fa fa-user-circle-o"></i>
            
            <span>关于</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/friends" class="waves-effect waves-light">
            
            <i class="fa fa-address-book"></i>
            
            <span>友情链接</span>
        </a>
    </li>
    
    <li>
        <a id="toggleSearch" class="waves-effect waves-light">
            <i id="searchIcon" class="mdi-action-search" title="搜索"></i>
        </a>
    </li>

</ul>

<div class="side-nav" id="mobile-nav">

    <div class="mobile-head bg-color">
        
        <img src="/medias/logo.png" class="logo-img circle responsive-img">
        
        <div class="logo-name">James</div>
        <div class="logo-desc">
            
            人生苦短，若虚度年华，则短暂的人生就太长了。 —— 莎士比亚
            
        </div>
    </div>

    

    <ul class="menu-list mobile-menu-list">
        
        <li>
            <a href="/" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-home"></i>
                
                首页
            </a>
        </li>
        
        <li>
            <a href="/tags" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-tags"></i>
                
                标签
            </a>
        </li>
        
        <li>
            <a href="/categories" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-bookmark"></i>
                
                分类
            </a>
        </li>
        
        <li>
            <a href="/archives" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-archive"></i>
                
                归档
            </a>
        </li>
        
        <li>
            <a href="/about" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-user-circle-o"></i>
                
                关于
            </a>
        </li>
        
        <li>
            <a href="/friends" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-address-book"></i>
                
                友情链接
            </a>
        </li>
        
        
        <li><div class="divider"></div></li>
        <li>
            <a href="https://github.com/james-ok" class="waves-effect waves-light" target="_blank">
                <i class="fa fa-github-square fa-fw"></i>Fork Me
            </a>
        </li>
        
    </ul>

    <div class="social-link">
    <a href="https://github.com/james-ok" class="tooltipped" target="_blank" data-tooltip="访问我的GitHub" data-position="top" data-delay="50">
        <i class="fa fa-github"></i>
    </a>



    <a href="mailto:vip.dujuncheng@foxmail.com" class="tooltipped" target="_blank" data-tooltip="邮件联系我" data-position="top" data-delay="50">
        <i class="fa fa-envelope-open"></i>
    </a>



    <a href="tencent://AddContact/?fromId=50&fromSubId=1&subcmd=all&uin=1261100508" class="tooltipped" data-tooltip="QQ联系我: 1261100508" data-position="top" data-delay="50">
        <i class="fa fa-qq"></i>
    </a>


</div>
</div>

            </div>
        </div>

        
        <style>
    .nav-transparent .github-corner {
        display: none !important;
    }

    .github-corner {
        position: absolute;
        z-index: 10;
        top: 0;
        right: 0;
        border: 0;
        transform: scale(1.1);
    }

    .github-corner svg {
        color: #0f9d58;
        fill: #fff;
        height: 64px;
        width: 64px;
    }

    .github-corner:hover .octo-arm {
        animation: a 0.56s ease-in-out;
    }

    .github-corner .octo-arm {
        animation: none;
    }

    @keyframes a {
        0%,
        to {
            transform: rotate(0);
        }
        20%,
        60% {
            transform: rotate(-25deg);
        }
        40%,
        80% {
            transform: rotate(10deg);
        }
    }
</style>

<a href="https://github.com/james-ok" class="github-corner tooltipped hide-on-med-and-down" target="_blank"
   data-tooltip="Fork Me" data-position="left" data-delay="50">
    <svg viewBox="0 0 250 250" aria-hidden="true">
        <path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path>
        <path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2"
              fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path>
        <path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z"
              fill="currentColor" class="octo-body"></path>
    </svg>
</a>
        
    </nav>
</header>





<div class="bg-cover post-cover" style="background-image: url('/medias/featureimages/13.jpg')">
    <div class="container">
        <div class="row">
            <div class="col s12 m12 l12">
                <div class="brand">
                    <div class="description center-align post-title">
                        ActiveMQ使用
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>



<main class="post-container content">

    
    <link rel="stylesheet" href="/libs/tocbot/tocbot.css">
<style>
    #articleContent h1::before,
    #articleContent h2::before,
    #articleContent h3::before,
    #articleContent h4::before,
    #articleContent h5::before,
    #articleContent h6::before {
        display: block;
        content: " ";
        height: 100px;
        margin-top: -100px;
        visibility: hidden;
    }

    #articleContent :focus {
        outline: none;
    }

    .toc-fixed {
        position: fixed;
        top: 64px;
    }

    .toc-widget {
        padding-left: 20px;
    }

    .toc-widget .toc-title {
        margin: 35px 0 15px 0;
        padding-left: 17px;
        font-size: 1.5rem;
        font-weight: bold;
        line-height: 1.5rem;
    }

    .toc-widget ol {
        padding: 0;
        list-style: none;
    }

    #toc-content ol {
        padding-left: 10px;
    }

    #toc-content ol li {
        padding-left: 10px;
    }

    #toc-content .toc-link:hover {
        color: #42b983;
        font-weight: 700;
        text-decoration: underline;
    }

    #toc-content .toc-link::before {
        background-color: transparent;
        max-height: 25px;
    }

    #toc-content .is-active-link {
        color: #42b983;
    }

    #toc-content .is-active-link::before {
        background-color: #42b983;
    }
</style>
<div class="row">
    <div class="col s12 m12 l9">
        <!-- 文章内容详情 -->
<div id="artDetail">
    <div class="card">
        <div class="card-content article-info">
            <div class="row tag-cate">
                <div class="col s7">
                    
                    <div class="article-tag">
                        
                            <a href="/tags/ActiveMQ/" target="_blank">
                                <span class="chip bg-color">ActiveMQ</span>
                            </a>
                        
                            <a href="/tags/JMS/" target="_blank">
                                <span class="chip bg-color">JMS</span>
                            </a>
                        
                    </div>
                    
                </div>
                <div class="col s5 right-align">
                    
                    <div class="post-cate">
                        <i class="fa fa-bookmark fa-fw icon-category"></i>
                        
                            <a href="/categories/ActiveMQ/" class="post-category" target="_blank">
                                ActiveMQ
                            </a>
                        
                    </div>
                    
                </div>
            </div>

            <div class="post-info">
                <div class="post-date info-break-policy">
                    <i class="fa fa-calendar-minus-o fa-fw"></i>发布日期:&nbsp;&nbsp;
                    2019-11-30
                </div>

                
                    
                    <div class="info-break-policy">
                        <i class="fa fa-file-word-o fa-fw"></i>文章字数:&nbsp;&nbsp;
                        6.6k
                    </div>
                    

                    
                    <div class="info-break-policy">
                        <i class="fa fa-clock-o fa-fw"></i>阅读时长:&nbsp;&nbsp;
                        27 分
                    </div>
                    
                
				
				
                    <div id="busuanzi_container_page_pv" class="info-break-policy">
                        <i class="fa fa-eye fa-fw"></i>阅读次数:&nbsp;&nbsp;
                        <span id="busuanzi_value_page_pv"></span>
                    </div>
				
            </div>
        </div>
        <hr class="clearfix">
        <div class="card-content article-card-content">
            <div id="articleContent">
                <p>相信大家遇到过这样的场景，用户注册这个简单的功能里面集成了太多不是很重要步骤，但又不得不做。比如发送邮件、发放优惠券、发送推销短信、记录日志，这样就导致了我们注册功能特别繁重，<br>极大的拉低了接口性能，给用户带来体验度大大降低，明明就一个注册用户信息持久化的功能居然需要做这么多不是主线流程的事情。当你遇到这样的业务场景的时候就可以考虑使用消息队列来实现<br>解耦，经过优化过后，我们的注册功能就只需要将用户信息持久化到数据库，然后向MQ中间件发送一条消息，然后返回，如果说之前的每个操作需要一秒，那总得就需要5S，但是经过使用MQ解耦过后<br>只需要1S左右，大大提升了用户体验。</p>
<h2 id="JMS"><a href="#JMS" class="headerlink" title="JMS"></a>JMS</h2><p>JMS(Java Message Service)是Java为各个消息中间件提供的一套统一API规范，其目的是规避各个中间件协议、接口的不同而带来的不便。以下是JMS连接流程图：<br><img src="/2019/11/30/ActiveMQ使用/JMS%E6%B5%81%E7%A8%8B.png" alt="JMS连接流程图"></p>
<h3 id="消息传递模式"><a href="#消息传递模式" class="headerlink" title="消息传递模式"></a>消息传递模式</h3><p>JMS提供两种常见的消息传递模式或域，分别是：</p>
<ul>
<li>P2P(点对点的消息传递模式):一个消息生成者对应一个消费者，两者之间不存在时间上的相关性（即，就算消费者不在线，生产者照样可以发送消息到<code>Broker</code>上，等消费者上线过后继续消费）</li>
<li>PUB/SUB(发布订阅的消息传递模式):一个消息生产者对应多个消息消费者，两者之间存在时间上的相关性（即，消费者只能收到订阅过后并且在线时生产者发送的消息，但不是绝对，JMS允许<br>消费者创建持久化订阅，持久订阅允许消费者消费他不在线时发送的消息）</li>
</ul>
<h3 id="消息类型或结构组成"><a href="#消息类型或结构组成" class="headerlink" title="消息类型或结构组成"></a>消息类型或结构组成</h3><p>消息的结构由消息头、消息体、属性组成</p>
<ul>
<li>消息头：消息头包含消息识别和路由信息</li>
<li>消息体：一般是我们发送的消息内容</li>
<li>消息属性：属性分为应用设置的属性、标准属性、中间件定义的属性<br>JMS提供六种消息类型，分别是：</li>
<li>TextMessage:文本消息</li>
<li>MapMessage:键值对消息，键是String类型，值可以是Java的任何类型</li>
<li>BytesMessage:字节流消息</li>
<li>StreamMessage:输入输出流消息</li>
<li>ObjectMessage:可序列化对象消息</li>
<li>Message:空消息，不包含有消息体，只有消息头和属性</li>
</ul>
<h2 id="ActiveMQ"><a href="#ActiveMQ" class="headerlink" title="ActiveMQ"></a>ActiveMQ</h2><h3 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h3><ul>
<li><a href="http://www.apache.org/dyn/closer.cgi?filename=/activemq/5.15.10/apache-activemq-5.15.10-bin.tar.gz&action=download" target="_blank" rel="noopener">下载</a></li>
<li>解压:<code>tar -zxvf apache-activemq-5.15.9-bin.tar.gz</code></li>
<li>启动:<code>sh activemq start</code></li>
<li>访问:<a href="http://localhost:8161" target="_blank" rel="noopener">http://localhost:8161</a></li>
</ul>
<h3 id="P2P-Queue-消息传递方式"><a href="#P2P-Queue-消息传递方式" class="headerlink" title="P2P(Queue)消息传递方式"></a>P2P(Queue)消息传递方式</h3><ul>
<li><p>消息生产者</p>
<pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">QueueProvider</span> <span class="token punctuation">{</span>
  <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> JMSException <span class="token punctuation">{</span>
      <span class="token comment" spellcheck="true">//创建连接工厂</span>
      ConnectionFactory connectionFactory <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ActiveMQConnectionFactory</span><span class="token punctuation">(</span><span class="token string">"tcp://192.168.3.224:61616"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment" spellcheck="true">//创建连接</span>
      Connection connection <span class="token operator">=</span> connectionFactory<span class="token punctuation">.</span><span class="token function">createConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment" spellcheck="true">//建立连接</span>
      connection<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment" spellcheck="true">//创建会话</span>
      Session session <span class="token operator">=</span> connection<span class="token punctuation">.</span><span class="token function">createSession</span><span class="token punctuation">(</span>Boolean<span class="token punctuation">.</span>TRUE<span class="token punctuation">,</span> Session<span class="token punctuation">.</span>AUTO_ACKNOWLEDGE<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment" spellcheck="true">//创建目的地</span>
      Destination destination <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ActiveMQQueue</span><span class="token punctuation">(</span><span class="token string">"testQueue"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment" spellcheck="true">//创建消息生产者</span>
      MessageProducer producer <span class="token operator">=</span> session<span class="token punctuation">.</span><span class="token function">createProducer</span><span class="token punctuation">(</span>destination<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment" spellcheck="true">//创建消息</span>
      TextMessage message <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ActiveMQTextMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      message<span class="token punctuation">.</span><span class="token function">setText</span><span class="token punctuation">(</span><span class="token string">"Hello World"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment" spellcheck="true">//发送消息</span>
      producer<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment" spellcheck="true">//提交消息事务，该方法只有在事务型会话时使用</span>
      session<span class="token punctuation">.</span><span class="token function">commit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment" spellcheck="true">//关闭会话</span>
      session<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment" spellcheck="true">//关闭连接</span>
      connection<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
<li><p>消息消费者</p>
<pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">QueueConsumer</span> <span class="token punctuation">{</span>
  <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> JMSException <span class="token punctuation">{</span>
      <span class="token comment" spellcheck="true">//创建连接工厂</span>
      ConnectionFactory connectionFactory <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ActiveMQConnectionFactory</span><span class="token punctuation">(</span><span class="token string">"tcp://192.168.3.224:61616"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment" spellcheck="true">//创建连接</span>
      Connection connection <span class="token operator">=</span> connectionFactory<span class="token punctuation">.</span><span class="token function">createConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment" spellcheck="true">//建立连接</span>
      connection<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment" spellcheck="true">//创建会话</span>
      Session session <span class="token operator">=</span> connection<span class="token punctuation">.</span><span class="token function">createSession</span><span class="token punctuation">(</span>Boolean<span class="token punctuation">.</span>TRUE<span class="token punctuation">,</span> Session<span class="token punctuation">.</span>AUTO_ACKNOWLEDGE<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment" spellcheck="true">//创建目的地</span>
      Destination destination <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ActiveMQQueue</span><span class="token punctuation">(</span><span class="token string">"testQueue"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment" spellcheck="true">//创建消费者</span>
      MessageConsumer consumer <span class="token operator">=</span> session<span class="token punctuation">.</span><span class="token function">createConsumer</span><span class="token punctuation">(</span>destination<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment" spellcheck="true">//消费消息</span>
      TextMessage message <span class="token operator">=</span> <span class="token punctuation">(</span>TextMessage<span class="token punctuation">)</span>consumer<span class="token punctuation">.</span><span class="token function">receive</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment" spellcheck="true">//输出消息（处理消息）</span>
      System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>message<span class="token punctuation">.</span><span class="token function">getText</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment" spellcheck="true">//确认消息，该方法只有在事务型会话时使用</span>
      session<span class="token punctuation">.</span><span class="token function">commit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment" spellcheck="true">//关闭会话</span>
      session<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment" spellcheck="true">//关闭连接</span>
      connection<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>消息消费还可以使用监听器的方式，代码如下(片段)：</p>
<pre class="line-numbers language-java"><code class="language-java"><span class="token comment" spellcheck="true">//...</span>
<span class="token comment" spellcheck="true">//创建消费者</span>
MessageConsumer consumer <span class="token operator">=</span> session<span class="token punctuation">.</span><span class="token function">createConsumer</span><span class="token punctuation">(</span>destination<span class="token punctuation">)</span><span class="token punctuation">;</span>
MessageListener messageListener <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MessageListener</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onMessage</span><span class="token punctuation">(</span>Message message<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      TextMessage textMessage <span class="token operator">=</span> <span class="token punctuation">(</span>TextMessage<span class="token punctuation">)</span> message<span class="token punctuation">;</span>
      System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>textMessage<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">//设置消息监听</span>
consumer<span class="token punctuation">.</span><span class="token function">setMessageListener</span><span class="token punctuation">(</span>messageListener<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">//确认消息，该方法只有在事务型会话时使用</span>
session<span class="token punctuation">.</span><span class="token function">commit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">//...</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
</ul>
<h3 id="PUB-SUB-发布-订阅-消息传递方式"><a href="#PUB-SUB-发布-订阅-消息传递方式" class="headerlink" title="PUB/SUB(发布/订阅)消息传递方式"></a>PUB/SUB(发布/订阅)消息传递方式</h3><ul>
<li><p>消息生产者</p>
<pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TopicProvider</span> <span class="token punctuation">{</span>
  <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> JMSException <span class="token punctuation">{</span>
      <span class="token comment" spellcheck="true">//创建连接工厂</span>
      ConnectionFactory connectionFactory <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ActiveMQConnectionFactory</span><span class="token punctuation">(</span><span class="token string">"tcp://192.168.3.224:61616"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment" spellcheck="true">//创建连接</span>
      Connection connection <span class="token operator">=</span> connectionFactory<span class="token punctuation">.</span><span class="token function">createConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment" spellcheck="true">//建立连接</span>
      connection<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment" spellcheck="true">//创建会话</span>
      Session session <span class="token operator">=</span> connection<span class="token punctuation">.</span><span class="token function">createSession</span><span class="token punctuation">(</span>Boolean<span class="token punctuation">.</span>TRUE<span class="token punctuation">,</span> Session<span class="token punctuation">.</span>AUTO_ACKNOWLEDGE<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment" spellcheck="true">//创建目的地</span>
      Destination destination <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ActiveMQTopic</span><span class="token punctuation">(</span><span class="token string">"testTopic"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment" spellcheck="true">//创建消息生产者</span>
      MessageProducer producer <span class="token operator">=</span> session<span class="token punctuation">.</span><span class="token function">createProducer</span><span class="token punctuation">(</span>destination<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment" spellcheck="true">//创建消息</span>
      TextMessage message <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ActiveMQTextMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      message<span class="token punctuation">.</span><span class="token function">setText</span><span class="token punctuation">(</span><span class="token string">"Hello World"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment" spellcheck="true">//发送消息</span>
      producer<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment" spellcheck="true">//提交消息事务，该方法只有在事务型会话时使用</span>
      session<span class="token punctuation">.</span><span class="token function">commit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment" spellcheck="true">//关闭会话</span>
      session<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment" spellcheck="true">//关闭连接</span>
      connection<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
<li><p>消息消费者</p>
<pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TopicConsumer</span> <span class="token punctuation">{</span>
  <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> JMSException <span class="token punctuation">{</span>
      <span class="token comment" spellcheck="true">//创建连接工厂</span>
      ConnectionFactory connectionFactory <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ActiveMQConnectionFactory</span><span class="token punctuation">(</span><span class="token string">"tcp://192.168.3.224:61616"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment" spellcheck="true">//创建连接</span>
      Connection connection <span class="token operator">=</span> connectionFactory<span class="token punctuation">.</span><span class="token function">createConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment" spellcheck="true">//建立连接</span>
      connection<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment" spellcheck="true">//创建会话</span>
      Session session <span class="token operator">=</span> connection<span class="token punctuation">.</span><span class="token function">createSession</span><span class="token punctuation">(</span>Boolean<span class="token punctuation">.</span>TRUE<span class="token punctuation">,</span> Session<span class="token punctuation">.</span>AUTO_ACKNOWLEDGE<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment" spellcheck="true">//创建目的地</span>
      Destination destination <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ActiveMQTopic</span><span class="token punctuation">(</span><span class="token string">"testTopic"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment" spellcheck="true">//创建消费者</span>
      MessageConsumer consumer <span class="token operator">=</span> session<span class="token punctuation">.</span><span class="token function">createConsumer</span><span class="token punctuation">(</span>destination<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment" spellcheck="true">//消费消息</span>
      TextMessage message <span class="token operator">=</span> <span class="token punctuation">(</span>TextMessage<span class="token punctuation">)</span>consumer<span class="token punctuation">.</span><span class="token function">receive</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment" spellcheck="true">//输出消息（处理消息）</span>
      System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>message<span class="token punctuation">.</span><span class="token function">getText</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment" spellcheck="true">//确认消息，该方法只有在事务型会话时使用</span>
      session<span class="token punctuation">.</span><span class="token function">commit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment" spellcheck="true">//关闭会话</span>
      session<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment" spellcheck="true">//关闭连接</span>
      connection<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>前面讲到JMS允许消费者创建持久化订阅，持久订阅允许消费者消费他不在线时发送的消息，实现这一需求需要改动消费者三个地方，分别是：</p>
<pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TopicConsumer</span> <span class="token punctuation">{</span>
  <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> JMSException <span class="token punctuation">{</span>
      <span class="token comment" spellcheck="true">//创建连接工厂</span>
      ConnectionFactory connectionFactory <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ActiveMQConnectionFactory</span><span class="token punctuation">(</span><span class="token string">"tcp://192.168.3.224:61616"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment" spellcheck="true">//创建连接</span>
      Connection connection <span class="token operator">=</span> connectionFactory<span class="token punctuation">.</span><span class="token function">createConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment" spellcheck="true">//配置客户端ID</span>
      connection<span class="token punctuation">.</span><span class="token function">setClientID</span><span class="token punctuation">(</span><span class="token string">"MrAToo-001"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//[1]</span>
      <span class="token comment" spellcheck="true">//建立连接</span>
      connection<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment" spellcheck="true">//创建会话</span>
      Session session <span class="token operator">=</span> connection<span class="token punctuation">.</span><span class="token function">createSession</span><span class="token punctuation">(</span>Boolean<span class="token punctuation">.</span>TRUE<span class="token punctuation">,</span> Session<span class="token punctuation">.</span>AUTO_ACKNOWLEDGE<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment" spellcheck="true">//创建目的地</span>
      Topic destination <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ActiveMQTopic</span><span class="token punctuation">(</span><span class="token string">"testTopic"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//[2]</span>
      <span class="token comment" spellcheck="true">//创建消费者</span>
      MessageConsumer consumer <span class="token operator">=</span> session<span class="token punctuation">.</span><span class="token function">createDurableSubscriber</span><span class="token punctuation">(</span>destination<span class="token punctuation">,</span><span class="token string">"MrAToo-001"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//[3]</span>
      <span class="token comment" spellcheck="true">//消费消息</span>
      TextMessage message <span class="token operator">=</span> <span class="token punctuation">(</span>TextMessage<span class="token punctuation">)</span>consumer<span class="token punctuation">.</span><span class="token function">receive</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment" spellcheck="true">//输出消息（处理消息）</span>
      System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>message<span class="token punctuation">.</span><span class="token function">getText</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment" spellcheck="true">//确认消息，该方法只有在事务型会话时使用</span>
      session<span class="token punctuation">.</span><span class="token function">commit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment" spellcheck="true">//关闭会话</span>
      session<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment" spellcheck="true">//关闭连接</span>
      connection<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
<li><p>标注[1]:<code>connection.setClientID(&quot;MrAToo-001&quot;);</code>为客户的设置一个ID</p>
</li>
<li><p>标注[2]:<code>Topic destination = new ActiveMQTopic(&quot;testTopic&quot;);</code>接受参数使用<code>Destination</code>的子类<code>Topic</code></p>
</li>
<li><p>标注[3]:<code>MessageConsumer consumer = session.createDurableSubscriber(destination,&quot;MrAToo-001&quot;);</code>调用<code>session.createDurableSubscriber</code>方法</p>
</li>
</ul>
<p>通过上面的配置，在<code>Broker</code>上会存在一条客户端记录<br><img src="/2019/11/30/ActiveMQ使用/ActiveMQ-Broker.jpg" alt="Broker截图"></p>
<h2 id="JMS消息的可靠方式"><a href="#JMS消息的可靠方式" class="headerlink" title="JMS消息的可靠方式"></a>JMS消息的可靠方式</h2><p>正常情况下，消息消费有三个阶段：消息接收、消息处理、消息确认，在消息在被收到处理完毕并且确认过后被视为消息被成功消费。</p>
<h3 id="事务型会话"><a href="#事务型会话" class="headerlink" title="事务型会话"></a>事务型会话</h3><p>在事务型会话中，消息生产者和消息消费者均需要调用<code>session.commit</code>方法，对于生产者而言，<code>commit</code>表示消息提交，只有提交的消息才会存在<code>Broker</code>中，才能被消费者消费<br>对于消费者而言，<code>commit</code>表示消息被确认，只有被确认的消息，<code>Broker</code>才不会再次重发消息，很大程度上能避免消息重发的问题（但是并不能正在意义上解决消息的重复消费）。<br>相反的还有<code>session.rollback</code>，该方法表示对之前做的所有操作进行作废处理，对于生成者而言，已经发送的消息回滚。对于消费者而言，当前消息标记为未接受，<code>Broker</code>会重发消息。</p>
<blockquote>
<p>注意：必须保证生产者和消费者都是事务型会话</p>
</blockquote>
<h3 id="非事务型会话"><a href="#非事务型会话" class="headerlink" title="非事务型会话"></a>非事务型会话</h3><p>在非事务型会话中，消息何时被确认取决于创建会话时的应答模式(acknowledgement mode)，应答模式有三种：</p>
<ul>
<li>Session.AUTO_ACKNOWLEDGE(自动确认):消息在被收到时自动确认消息</li>
<li>Session.CLIENT_ACKNOWLEDGE(手动确认):消费者在收到消息过后，处理完毕通过手动调用<code>message.acknowledge();</code>进行手动确认，需要注意的是：该方法确认该会话中所有被处理的消息。</li>
<li>Session.DUPS_ACKNOWLEDGE(消息延迟确认):该选择只是会话迟钝的确认消息的提交</li>
</ul>
<h2 id="消息的持久化存储"><a href="#消息的持久化存储" class="headerlink" title="消息的持久化存储"></a>消息的持久化存储</h2><h3 id="非持久化"><a href="#非持久化" class="headerlink" title="非持久化"></a>非持久化</h3><p>该模式不会将消息存储到可靠的存储介质中（例如：磁盘，DB），只会存在于内存中，如果<code>Broker</code>出现宕机，则消息会丢失</p>
<h3 id="持久化"><a href="#持久化" class="headerlink" title="持久化"></a>持久化</h3><p>该模式会将生产者发送到<code>Broker</code>的消息持久化到可靠存储介质中，即使是<code>Broker</code>出现宕机，也不会出现消息丢失的情况，但是，由于生产者或者消费者在发送或者确认消息的过程中，<br><code>Broker</code>需要将消息从可靠存储介质中保存或者删除，从而带来了IO开销，性能上比非持久化存储方式相对来说较低</p>
<h2 id="持久化消息和非持久化消息的发送策略"><a href="#持久化消息和非持久化消息的发送策略" class="headerlink" title="持久化消息和非持久化消息的发送策略"></a>持久化消息和非持久化消息的发送策略</h2><h3 id="消息的同步发送和异步发送"><a href="#消息的同步发送和异步发送" class="headerlink" title="消息的同步发送和异步发送"></a>消息的同步发送和异步发送</h3><p>同步发送：消息生产者发送一条消息到<code>Broker</code>上，会被阻塞直到<code>Broker</code>返回一条确认收到ACK，线程才会被释放，该方式确保了消息的可靠投递，但由于会阻塞，因此会有性能上的损耗。<br>异步发送：消息生产者发送一条消息过后立即返回，当<code>Broker</code>处理完成过后，会回调返回消息确认ACK，这种方式性能相对较高，但丢失消息的可能性相对较高。</p>
<p>默认情况下：非持久化的消息都是异步发送的。持久化消息在非事务模式下是同步发送的。在开启事务的情况下，消息都是异步发送。</p>
<p>除了默认的发送策略外，我们可以设置消息发送的策略，通过在连接URL中添加参数<code>tcp://localhost:61616?jms.useAsyncSend=true</code>，也可以调用<code>ActiveMQConnectionFactory</code>的<code>setUseAsyncSend</code>为<code>true</code></p>
<h2 id="消息发送原理分析"><a href="#消息发送原理分析" class="headerlink" title="消息发送原理分析"></a>消息发送原理分析</h2><p>源码分析我们从<code>producer.send(message);</code>开始，当然前面还有<code>producer</code>的创建过程，先不看。<code>producer.send(message);</code>方法首先会调用到<code>ActiveMQMessageProducer</code>的<code>send</code>方法。该方法如下：</p>
<pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">class</span> <span class="token class-name">ActiveMQMessageProducer</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">send</span><span class="token punctuation">(</span>Destination destination<span class="token punctuation">,</span> Message message<span class="token punctuation">,</span> <span class="token keyword">int</span> deliveryMode<span class="token punctuation">,</span> <span class="token keyword">int</span> priority<span class="token punctuation">,</span> <span class="token keyword">long</span> timeToLive<span class="token punctuation">,</span> AsyncCallback onComplete<span class="token punctuation">)</span> <span class="token keyword">throws</span> JMSException <span class="token punctuation">{</span>
        <span class="token function">checkClosed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>destination <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>info<span class="token punctuation">.</span><span class="token function">getDestination</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">UnsupportedOperationException</span><span class="token punctuation">(</span><span class="token string">"A destination must be specified."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">InvalidDestinationException</span><span class="token punctuation">(</span><span class="token string">"Don't understand null destinations"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        ActiveMQDestination dest<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>destination<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>info<span class="token punctuation">.</span><span class="token function">getDestination</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            dest <span class="token operator">=</span> <span class="token punctuation">(</span>ActiveMQDestination<span class="token punctuation">)</span>destination<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>info<span class="token punctuation">.</span><span class="token function">getDestination</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            dest <span class="token operator">=</span> ActiveMQDestination<span class="token punctuation">.</span><span class="token function">transform</span><span class="token punctuation">(</span>destination<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">UnsupportedOperationException</span><span class="token punctuation">(</span><span class="token string">"This producer can only send messages to: "</span> <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>info<span class="token punctuation">.</span><span class="token function">getDestination</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getPhysicalName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>dest <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">JMSException</span><span class="token punctuation">(</span><span class="token string">"No destination specified"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>transformer <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            Message transformedMessage <span class="token operator">=</span> transformer<span class="token punctuation">.</span><span class="token function">producerTransform</span><span class="token punctuation">(</span>session<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">,</span> message<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>transformedMessage <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                message <span class="token operator">=</span> transformedMessage<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>producerWindow <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                producerWindow<span class="token punctuation">.</span><span class="token function">waitForSpace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">JMSException</span><span class="token punctuation">(</span><span class="token string">"Send aborted due to thread interrupt."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>session<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> dest<span class="token punctuation">,</span> message<span class="token punctuation">,</span> deliveryMode<span class="token punctuation">,</span> priority<span class="token punctuation">,</span> timeToLive<span class="token punctuation">,</span> producerWindow<span class="token punctuation">,</span> sendTimeout<span class="token punctuation">,</span> onComplete<span class="token punctuation">)</span><span class="token punctuation">;</span>
        stats<span class="token punctuation">.</span><span class="token function">onMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>该方法中首先判断当前会话状态是否关闭，然后如果<code>producerWindow</code>不为null则判断当前消息根据发送窗口的大小判断是否阻塞，最后调用<code>ActiveMQSession</code>的<code>send</code>方法，该方法如下：</p>
<pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">class</span> <span class="token class-name">ActiveMQSession</span> <span class="token punctuation">{</span>
    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">send</span><span class="token punctuation">(</span>ActiveMQMessageProducer producer<span class="token punctuation">,</span> ActiveMQDestination destination<span class="token punctuation">,</span> Message message<span class="token punctuation">,</span> <span class="token keyword">int</span> deliveryMode<span class="token punctuation">,</span> <span class="token keyword">int</span> priority<span class="token punctuation">,</span> <span class="token keyword">long</span> timeToLive<span class="token punctuation">,</span>
                        MemoryUsage producerWindow<span class="token punctuation">,</span> <span class="token keyword">int</span> sendTimeout<span class="token punctuation">,</span> AsyncCallback onComplete<span class="token punctuation">)</span> <span class="token keyword">throws</span> JMSException <span class="token punctuation">{</span>
        <span class="token function">checkClosed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>destination<span class="token punctuation">.</span><span class="token function">isTemporary</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> connection<span class="token punctuation">.</span><span class="token function">isDeleted</span><span class="token punctuation">(</span>destination<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">InvalidDestinationException</span><span class="token punctuation">(</span><span class="token string">"Cannot publish to a deleted Destination: "</span> <span class="token operator">+</span> destination<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>sendMutex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// tell the Broker we are about to start a new transaction</span>
            <span class="token function">doStartTransaction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//[1]</span>
            TransactionId txid <span class="token operator">=</span> transactionContext<span class="token punctuation">.</span><span class="token function">getTransactionId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">long</span> sequenceNumber <span class="token operator">=</span> producer<span class="token punctuation">.</span><span class="token function">getMessageSequence</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment" spellcheck="true">//Set the "JMS" header fields on the original message, see 1.1 spec section 3.4.11</span>
            message<span class="token punctuation">.</span><span class="token function">setJMSDeliveryMode</span><span class="token punctuation">(</span>deliveryMode<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">long</span> expiration <span class="token operator">=</span> 0L<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>producer<span class="token punctuation">.</span><span class="token function">getDisableMessageTimestamp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">long</span> timeStamp <span class="token operator">=</span> System<span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                message<span class="token punctuation">.</span><span class="token function">setJMSTimestamp</span><span class="token punctuation">(</span>timeStamp<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>timeToLive <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    expiration <span class="token operator">=</span> timeToLive <span class="token operator">+</span> timeStamp<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            message<span class="token punctuation">.</span><span class="token function">setJMSExpiration</span><span class="token punctuation">(</span>expiration<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//[2]</span>
            message<span class="token punctuation">.</span><span class="token function">setJMSPriority</span><span class="token punctuation">(</span>priority<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//[3]</span>
            message<span class="token punctuation">.</span><span class="token function">setJMSRedelivered</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//[4]</span>

            <span class="token comment" spellcheck="true">// transform to our own message format here</span>
            ActiveMQMessage msg <span class="token operator">=</span> ActiveMQMessageTransformation<span class="token punctuation">.</span><span class="token function">transformMessage</span><span class="token punctuation">(</span>message<span class="token punctuation">,</span> connection<span class="token punctuation">)</span><span class="token punctuation">;</span>
            msg<span class="token punctuation">.</span><span class="token function">setDestination</span><span class="token punctuation">(</span>destination<span class="token punctuation">)</span><span class="token punctuation">;</span>
            msg<span class="token punctuation">.</span><span class="token function">setMessageId</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">MessageId</span><span class="token punctuation">(</span>producer<span class="token punctuation">.</span><span class="token function">getProducerInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getProducerId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> sequenceNumber<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment" spellcheck="true">// Set the message id.</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>msg <span class="token operator">!=</span> message<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                message<span class="token punctuation">.</span><span class="token function">setJMSMessageID</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span><span class="token function">getMessageId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// Make sure the JMS destination is set on the foreign messages too.</span>
                message<span class="token punctuation">.</span><span class="token function">setJMSDestination</span><span class="token punctuation">(</span>destination<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">//clear the brokerPath in case we are re-sending this message</span>
            msg<span class="token punctuation">.</span><span class="token function">setBrokerPath</span><span class="token punctuation">(</span>null<span class="token punctuation">)</span><span class="token punctuation">;</span>

            msg<span class="token punctuation">.</span><span class="token function">setTransactionId</span><span class="token punctuation">(</span>txid<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>connection<span class="token punctuation">.</span><span class="token function">isCopyMessageOnSend</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                msg <span class="token operator">=</span> <span class="token punctuation">(</span>ActiveMQMessage<span class="token punctuation">)</span>msg<span class="token punctuation">.</span><span class="token function">copy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            msg<span class="token punctuation">.</span><span class="token function">setConnection</span><span class="token punctuation">(</span>connection<span class="token punctuation">)</span><span class="token punctuation">;</span>
            msg<span class="token punctuation">.</span><span class="token function">onSend</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            msg<span class="token punctuation">.</span><span class="token function">setProducerId</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span><span class="token function">getMessageId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getProducerId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>LOG<span class="token punctuation">.</span><span class="token function">isTraceEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                LOG<span class="token punctuation">.</span><span class="token function">trace</span><span class="token punctuation">(</span><span class="token function">getSessionId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">" sending message: "</span> <span class="token operator">+</span> msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">//[5]</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>onComplete<span class="token operator">==</span>null <span class="token operator">&amp;&amp;</span> sendTimeout <span class="token operator">&lt;=</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>msg<span class="token punctuation">.</span><span class="token function">isResponseRequired</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>connection<span class="token punctuation">.</span><span class="token function">isAlwaysSyncSend</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span><span class="token operator">!</span>msg<span class="token punctuation">.</span><span class="token function">isPersistent</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">||</span> connection<span class="token punctuation">.</span><span class="token function">isUseAsyncSend</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">||</span> txid <span class="token operator">!=</span> null<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>connection<span class="token punctuation">.</span><span class="token function">asyncSendPacket</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>producerWindow <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// Since we defer lots of the marshaling till we hit the</span>
                    <span class="token comment" spellcheck="true">// wire, this might not</span>
                    <span class="token comment" spellcheck="true">// provide and accurate size. We may change over to doing</span>
                    <span class="token comment" spellcheck="true">// more aggressive marshaling,</span>
                    <span class="token comment" spellcheck="true">// to get more accurate sizes.. this is more important once</span>
                    <span class="token comment" spellcheck="true">// users start using producer window</span>
                    <span class="token comment" spellcheck="true">// flow control.</span>
                    <span class="token comment" spellcheck="true">//[6]</span>
                    <span class="token keyword">int</span> size <span class="token operator">=</span> msg<span class="token punctuation">.</span><span class="token function">getSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    producerWindow<span class="token punctuation">.</span><span class="token function">increaseUsage</span><span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>sendTimeout <span class="token operator">></span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> onComplete<span class="token operator">==</span>null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">this</span><span class="token punctuation">.</span>connection<span class="token punctuation">.</span><span class="token function">syncSendPacket</span><span class="token punctuation">(</span>msg<span class="token punctuation">,</span>sendTimeout<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token punctuation">{</span>
                    <span class="token keyword">this</span><span class="token punctuation">.</span>connection<span class="token punctuation">.</span><span class="token function">syncSendPacket</span><span class="token punctuation">(</span>msg<span class="token punctuation">,</span> onComplete<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>

        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>该方法中也是先判断当前会话，然后采用同步的方式有序的执行.</p>
<ul>
<li>标注[1]:这里表示开启一个事务</li>
<li>标注[2]:设置过期时间</li>
<li>标注[3]:设置优先级</li>
<li>标注[4]:设置为非重发消息</li>
<li>标注[5]:这里的if判断决定消息是异步发送还是同步发送，这里有两种情况：当<code>onComplete</code>没有设置，并且发送超时时间小于0，并且不是必须返回<code>response</code>响应，并且不是同步发送模式，并且消息是非持久化或者连接器是异步发送模式或者存在事务ID时走异步发送，否则走同步发送</li>
<li>标注[6]:异步发送会设置消息发送的大小</li>
</ul>
<h3 id="异步发送"><a href="#异步发送" class="headerlink" title="异步发送"></a>异步发送</h3><p>异步发送会调用<code>ActiveMQConnection</code>中的<code>doAsyncSendPacket</code>方法，该方法中会调用<code>transport.oneway</code>方法，那么这里的<code>transport</code>是什么呢，其实<code>transport</code>在创建<code>ActiveMQConnection</code>链接的时候就已经创建了<br>代码在<code>ActiveMQConnectionFactory.createActiveMQConnection</code>方法中，<code>Transport transport = createTransport();</code>通过<code>createTransport</code>方法创建一个<code>transport</code>，代码如下：</p>
<pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">class</span> <span class="token class-name">ActiveMQConnectionFactory</span><span class="token punctuation">{</span>
    <span class="token keyword">protected</span> Transport <span class="token function">createTransport</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> JMSException <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            URI connectBrokerUL <span class="token operator">=</span> brokerURL<span class="token punctuation">;</span>
            String scheme <span class="token operator">=</span> brokerURL<span class="token punctuation">.</span><span class="token function">getScheme</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>scheme <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IOException</span><span class="token punctuation">(</span><span class="token string">"Transport not scheme specified: ["</span> <span class="token operator">+</span> brokerURL <span class="token operator">+</span> <span class="token string">"]"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>scheme<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">"auto"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                connectBrokerUL <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">URI</span><span class="token punctuation">(</span>brokerURL<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token string">"auto"</span><span class="token punctuation">,</span> <span class="token string">"tcp"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>scheme<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">"auto+ssl"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                connectBrokerUL <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">URI</span><span class="token punctuation">(</span>brokerURL<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token string">"auto+ssl"</span><span class="token punctuation">,</span> <span class="token string">"ssl"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>scheme<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">"auto+nio"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                connectBrokerUL <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">URI</span><span class="token punctuation">(</span>brokerURL<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token string">"auto+nio"</span><span class="token punctuation">,</span> <span class="token string">"nio"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>scheme<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">"auto+nio+ssl"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                connectBrokerUL <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">URI</span><span class="token punctuation">(</span>brokerURL<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token string">"auto+nio+ssl"</span><span class="token punctuation">,</span> <span class="token string">"nio+ssl"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> TransportFactory<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span>connectBrokerUL<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> JMSExceptionSupport<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token string">"Could not create Transport. Reason: "</span> <span class="token operator">+</span> e<span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>通过<code>TransportFactory.connect</code>静态方法创建一个<code>Transport</code></p>
<pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">class</span> <span class="token class-name">TransportFactory</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> FactoryFinder TRANSPORT_FACTORY_FINDER <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FactoryFinder</span><span class="token punctuation">(</span><span class="token string">"META-INF/services/org/apache/activemq/transport/"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> Transport <span class="token function">connect</span><span class="token punctuation">(</span>URI location<span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception <span class="token punctuation">{</span>
        TransportFactory tf <span class="token operator">=</span> <span class="token function">findTransportFactory</span><span class="token punctuation">(</span>location<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> tf<span class="token punctuation">.</span><span class="token function">doConnect</span><span class="token punctuation">(</span>location<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> TransportFactory <span class="token function">findTransportFactory</span><span class="token punctuation">(</span>URI location<span class="token punctuation">)</span> <span class="token keyword">throws</span> IOException <span class="token punctuation">{</span>
        String scheme <span class="token operator">=</span> location<span class="token punctuation">.</span><span class="token function">getScheme</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>scheme <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IOException</span><span class="token punctuation">(</span><span class="token string">"Transport not scheme specified: ["</span> <span class="token operator">+</span> location <span class="token operator">+</span> <span class="token string">"]"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        TransportFactory tf <span class="token operator">=</span> TRANSPORT_FACTORYS<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>scheme<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>tf <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// Try to load if from a META-INF property.</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                tf <span class="token operator">=</span> <span class="token punctuation">(</span>TransportFactory<span class="token punctuation">)</span>TRANSPORT_FACTORY_FINDER<span class="token punctuation">.</span><span class="token function">newInstance</span><span class="token punctuation">(</span>scheme<span class="token punctuation">)</span><span class="token punctuation">;</span>
                TRANSPORT_FACTORYS<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>scheme<span class="token punctuation">,</span> tf<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">throw</span> IOExceptionSupport<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token string">"Transport scheme NOT recognized: ["</span> <span class="token operator">+</span> scheme <span class="token operator">+</span> <span class="token string">"]"</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> tf<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这里大概的逻辑是：先从<code>META-INF/services/org/apache/activemq/transport/</code>路径下找到指定<code>scheme</code>(这里的<code>scheme</code>是<code>tcp</code>)然后通过反射加载得到<code>org.apache.activemq.transport.tcp.TcpTransportFactory</code>，<br>然后调用<code>TcpTransportFactory</code>的<code>doConnect</code>(该方法在父类<code>TransportFactory</code>中实现)，在该方法中，有这样一句代码<code>Transport rc = configure(transport, wf, options);</code>，该方法代码如下：</p>
<pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">class</span> <span class="token class-name">TransportFactory</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> Transport <span class="token function">configure</span><span class="token punctuation">(</span>Transport transport<span class="token punctuation">,</span> WireFormat wf<span class="token punctuation">,</span> Map options<span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception <span class="token punctuation">{</span>
        transport <span class="token operator">=</span> <span class="token function">compositeConfigure</span><span class="token punctuation">(</span>transport<span class="token punctuation">,</span> wf<span class="token punctuation">,</span> options<span class="token punctuation">)</span><span class="token punctuation">;</span>

        transport <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MutexTransport</span><span class="token punctuation">(</span>transport<span class="token punctuation">)</span><span class="token punctuation">;</span>
        transport <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ResponseCorrelator</span><span class="token punctuation">(</span>transport<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> transport<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>该方法的作用是包装<code>Transport</code>，所以，最终得到的是<code>ResponseCorrelator(MutexTransport(WireFormatNegotiator(InactivityMonitor(TcpTransport))))</code>调用链，这是几个<code>Filter</code>，这几个<code>Filter</code>大致的作用是：</p>
<ul>
<li>ResponseCorrelator：用于实现异步请求</li>
<li>MutexTransport：实现写锁，作用是保证了客户端向<code>Broker</code>发送消息时是按照顺序进行的，即同一时间只允许一个请求</li>
<li>InactivityMonitor：心跳机制，客户端每10s发送一次心跳，服务端每30s接受一次心跳</li>
<li>WireFormatNegotiator：实现客户端连接<code>Broker</code>时先发送协议数据信息<br>然后调用<code>TcpTransportFactory</code>的<code>createTransport</code>方法，最终<code>new TcpTransport</code>对象，然后回到<code>ActiveMQConnectionFactory</code>中，在<code>createActiveMQConnection</code>方法中调用了<code>transport.start</code>方法，这里在后面讲。<br>在这里面建立和<code>Broker</code>的连接，然后将该连接的<code>Socket</code>输出流保存到<code>dataOut</code>对象中。</li>
</ul>
<p>回到<code>ActiveMQConnection</code>中的<code>doAsyncSendPacket</code>方法中，调用<code>transport.oneway</code>方法，其实是调用的<code>TcpTransport.oneway</code>方法，这里会通过<code>dataOut</code>将消息发送到<code>Broker</code>上。</p>
<h3 id="同步发送"><a href="#同步发送" class="headerlink" title="同步发送"></a>同步发送</h3><p>在ActiveMQ中，同步发送其实也是调用的异步发送的方法，然后阻塞等待异步结果返回。</p>
<h2 id="持久化消息和非持久化消息的存储原理"><a href="#持久化消息和非持久化消息的存储原理" class="headerlink" title="持久化消息和非持久化消息的存储原理"></a>持久化消息和非持久化消息的存储原理</h2><p>当我们的应用场景不允许消息的丢失的时候，可以采用消息的持久化存储的方式来达到消息的永久存在，ActiveMQ支持五种消息的持久化机制。</p>
<h3 id="持久化消息的物种存储方式"><a href="#持久化消息的物种存储方式" class="headerlink" title="持久化消息的物种存储方式"></a>持久化消息的物种存储方式</h3><ul>
<li>KahaDB：默认ActiveMQ官方推荐的消息持久化方式，配置方式：<pre class="line-numbers language-xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>persistenceAdapter</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>kahaDB</span> <span class="token attr-name">directory</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>${activemq.data}/kahadb<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>persistenceAdapter</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
</li>
<li>JDBC：将消息持久化到关系型数据库中，支持MySQL，Oracle等主流数据库，该方式会在数据库中生成三张表，分别是：<ul>
<li>ACTIVEMQ_MSGS:用于存储持久化消息，Queue和Topic消息都在该表中</li>
<li>ACTIVEMQ_ACKS:存储持久订阅消息和最后一个持久订阅接收的消息ID</li>
<li>ACTIVEMQ_LOCKS:锁表，用来确保同一时刻只有一个<code>Broker</code>访问数据<br>配置方式：<pre class="line-numbers language-xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>persistenceAdapter</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>jdbcPersistenceAdapter</span> <span class="token attr-name">dataSource</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>#MySQL-DS <span class="token punctuation">"</span></span> <span class="token attr-name">createTablesOnStartup</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>true<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>persistenceAdapter</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
</li>
</ul>
</li>
<li>LevelDB：性能高于KahaDB，并且支持LevelDB+Zookeeper实现数据复制，但是官方不推荐</li>
<li>Memory：内存，不做消息的持久化时的默认方式</li>
<li>JDBC With ActiveMQ Journal：该方式是为了优化JDBC的方式，延迟批量将消息持久化到关系型数据库中，<code>ActiveMQ Journal</code>使用高缓存写入技术，大大提示性能，当消费者的消费能力很强的时候能大大减少<br>关系型数据库的事务操作，配置方式：<pre class="line-numbers language-xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>persistenceFactory</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>journalPersistenceAdapterFactory</span> <span class="token attr-name">dataSource</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>#Mysql-DS<span class="token punctuation">"</span></span> <span class="token attr-name">dataDirectory</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>activemqdata<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>persistenceFactory</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
</li>
</ul>
<h2 id="消息消费原理分析"><a href="#消息消费原理分析" class="headerlink" title="消息消费原理分析"></a>消息消费原理分析</h2><p>消息消费从<code>ActiveMQMessageConsumer</code>的<code>receive</code>开始，该方法首先检查连接，然后检查是否设置了<code>Listener</code>（<code>ActiveMQ</code>消费端只允许一种方式接受消息，原因是多种方式消息消费的事务性不好管控），<br>然后判断<code>prefetchSize</code>和<code>unconsumeMessages</code>是否为空，如果为空则向<code>Broker</code>发送一个拉取消息的<code>pull</code>命令，然后调用<code>dequeue</code>方法，该方法从<code>unConsumeMessages</code>中获取一个消息（如果<code>unConsumeMessages</code><br>中没有消息，则会阻塞当前线程直到<code>Broker</code>push一个消息或者超时释放），<code>unConsumeMessages</code>是一个未消费消息的通道，该通道的作用是每次从<code>Broker</code>上拉取<code>prefetchSize</code>条消息保存到本地，减少了客户端和服务端<br>频繁请求造成的网络开销。<br>继续往下，会调用<code>beforeMessageIsConsumed(md);</code>方法，该方法主要作用是做一些消息消费前的一些准备工作，如果ACK类型不是<code>DUPS_OK_ACKNOWLEDGE</code>或者不是队列类型（也就是除了<code>Topic</code>类型和<code>DUPS_OK_ACKNOWLEDGE</code>）<br>所有的消息先放到<code>deliveredMessages</code>链表的开头，并且如果是事务类型，则判断<code>transactedIndividualAck</code>，如果是true，表示单条消息直接返回ACK，否则，调用<code>ackLater</code>批量应答，消费端在消费<br>消息过后，先不发送ACK(<code>pendingACK</code>)，等到堆积的<code>pendingACK</code>达到一定的阈值过后，通过一个ACK指定将之前的所有全部确认，在性能上，这种方式会高很多。<br>然后继续往下，会调用<code>afterMessageIsConsumed</code>方法，该方法主要作用是执行应答，这里有以下几种情况</p>
<ul>
<li><p>如果消息过期，则返回消息过期的ack</p>
</li>
<li><p>如果是事务类型的会话，则不做任何处理</p>
</li>
<li><p>如果是AUTOACK或者（DUPS_OK_ACK且是队列），并且是优化ack操作，则走批量确认ack</p>
</li>
<li><p>如果是DUPS_OK_ACK，则走ackLater逻辑</p>
</li>
<li><p>如果是CLIENT_ACK，则执行ackLater<br>代码如下：</p>
<pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">class</span> <span class="token class-name">ActiveMQMessageConsumer</span> <span class="token punctuation">{</span>
  <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">afterMessageIsConsumed</span><span class="token punctuation">(</span>MessageDispatch md<span class="token punctuation">,</span> <span class="token keyword">boolean</span> messageExpired<span class="token punctuation">)</span> <span class="token keyword">throws</span> JMSException <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>unconsumedMessages<span class="token punctuation">.</span><span class="token function">isClosed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">return</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>messageExpired<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token function">acknowledge</span><span class="token punctuation">(</span>md<span class="token punctuation">,</span> MessageAck<span class="token punctuation">.</span>EXPIRED_ACK_TYPE<span class="token punctuation">)</span><span class="token punctuation">;</span>
          stats<span class="token punctuation">.</span><span class="token function">getExpiredMessageCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">increment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
          stats<span class="token punctuation">.</span><span class="token function">onMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>session<span class="token punctuation">.</span><span class="token function">getTransacted</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
              <span class="token comment" spellcheck="true">// Do nothing.</span>
          <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isAutoAcknowledgeEach</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
              <span class="token keyword">if</span> <span class="token punctuation">(</span>deliveryingAcknowledgements<span class="token punctuation">.</span><span class="token function">compareAndSet</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                  <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>deliveredMessages<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>deliveredMessages<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                          <span class="token keyword">if</span> <span class="token punctuation">(</span>optimizeAcknowledge<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                              ackCounter<span class="token operator">++</span><span class="token punctuation">;</span>

                              <span class="token comment" spellcheck="true">// AMQ-3956 evaluate both expired and normal msgs as</span>
                              <span class="token comment" spellcheck="true">// otherwise consumer may get stalled</span>
                              <span class="token keyword">if</span> <span class="token punctuation">(</span>ackCounter <span class="token operator">+</span> deliveredCounter <span class="token operator">>=</span> <span class="token punctuation">(</span>info<span class="token punctuation">.</span><span class="token function">getPrefetchSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token punctuation">.</span><span class="token number">65</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token punctuation">(</span>optimizeAcknowledgeTimeOut <span class="token operator">></span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> System<span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">>=</span> <span class="token punctuation">(</span>optimizeAckTimestamp <span class="token operator">+</span> optimizeAcknowledgeTimeOut<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                                  MessageAck ack <span class="token operator">=</span> <span class="token function">makeAckForAllDeliveredMessages</span><span class="token punctuation">(</span>MessageAck<span class="token punctuation">.</span>STANDARD_ACK_TYPE<span class="token punctuation">)</span><span class="token punctuation">;</span>
                                  <span class="token keyword">if</span> <span class="token punctuation">(</span>ack <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                                      deliveredMessages<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                                      ackCounter <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
                                      session<span class="token punctuation">.</span><span class="token function">sendAck</span><span class="token punctuation">(</span>ack<span class="token punctuation">)</span><span class="token punctuation">;</span>
                                      optimizeAckTimestamp <span class="token operator">=</span> System<span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                                  <span class="token punctuation">}</span>
                                  <span class="token comment" spellcheck="true">// AMQ-3956 - as further optimization send</span>
                                  <span class="token comment" spellcheck="true">// ack for expired msgs when there are any.</span>
                                  <span class="token comment" spellcheck="true">// This resets the deliveredCounter to 0 so that</span>
                                  <span class="token comment" spellcheck="true">// we won't sent standard acks with every msg just</span>
                                  <span class="token comment" spellcheck="true">// because the deliveredCounter just below</span>
                                  <span class="token comment" spellcheck="true">// 0.5 * prefetch as used in ackLater()</span>
                                  <span class="token keyword">if</span> <span class="token punctuation">(</span>pendingAck <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> deliveredCounter <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                                      session<span class="token punctuation">.</span><span class="token function">sendAck</span><span class="token punctuation">(</span>pendingAck<span class="token punctuation">)</span><span class="token punctuation">;</span>
                                      pendingAck <span class="token operator">=</span> null<span class="token punctuation">;</span>
                                      deliveredCounter <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
                                  <span class="token punctuation">}</span>
                              <span class="token punctuation">}</span>
                          <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                              MessageAck ack <span class="token operator">=</span> <span class="token function">makeAckForAllDeliveredMessages</span><span class="token punctuation">(</span>MessageAck<span class="token punctuation">.</span>STANDARD_ACK_TYPE<span class="token punctuation">)</span><span class="token punctuation">;</span>
                              <span class="token keyword">if</span> <span class="token punctuation">(</span>ack<span class="token operator">!=</span>null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                                  deliveredMessages<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                                  session<span class="token punctuation">.</span><span class="token function">sendAck</span><span class="token punctuation">(</span>ack<span class="token punctuation">)</span><span class="token punctuation">;</span>
                              <span class="token punctuation">}</span>
                          <span class="token punctuation">}</span>
                      <span class="token punctuation">}</span>
                  <span class="token punctuation">}</span>
                  deliveryingAcknowledgements<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
              <span class="token punctuation">}</span>
          <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isAutoAcknowledgeBatch</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
              <span class="token function">ackLater</span><span class="token punctuation">(</span>md<span class="token punctuation">,</span> MessageAck<span class="token punctuation">.</span>STANDARD_ACK_TYPE<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>session<span class="token punctuation">.</span><span class="token function">isClientAcknowledge</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">||</span>session<span class="token punctuation">.</span><span class="token function">isIndividualAcknowledge</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
              <span class="token keyword">boolean</span> messageUnackedByConsumer <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
              <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>deliveredMessages<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                  messageUnackedByConsumer <span class="token operator">=</span> deliveredMessages<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>md<span class="token punctuation">)</span><span class="token punctuation">;</span>
              <span class="token punctuation">}</span>
              <span class="token keyword">if</span> <span class="token punctuation">(</span>messageUnackedByConsumer<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                  <span class="token function">ackLater</span><span class="token punctuation">(</span>md<span class="token punctuation">,</span> MessageAck<span class="token punctuation">.</span>DELIVERED_ACK_TYPE<span class="token punctuation">)</span><span class="token punctuation">;</span>
              <span class="token punctuation">}</span>
          <span class="token punctuation">}</span>
          <span class="token keyword">else</span> <span class="token punctuation">{</span>
              <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalStateException</span><span class="token punctuation">(</span><span class="token string">"Invalid session state."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
</ul>
<h2 id="unconsumedMessages数据获取过程"><a href="#unconsumedMessages数据获取过程" class="headerlink" title="unconsumedMessages数据获取过程"></a>unconsumedMessages数据获取过程</h2><p><code>unconsumedMessages</code>未消费的消息通道是在什么时候被赋值的，这应该从连接的创建过程说起，在<code>ActiveMQConnectionFactory#createActiveMQConnection</code>连接创建是调用了<code>TcpTransport#start</code>方法（实际上是<code>ServiceSupport#start</code>），该方法中<br>调用<code>TcpTransport#doStart</code>，在该方法中通过<code>connect</code>方法和<code>Broker</code>创建连接，然后调用<code>TransportThreadSupport#doStart</code>，该方法中创建了一个线程，线程的内容在<code>TcpTransport</code>中，也就是<code>TcpTransport#run</code>，然后在<br>该方法中，只要<code>TcpTransport</code>没有停止，则一直调用<code>TcpTransport#doRun</code>，然后调用<code>Object command = readCommand();</code>从<code>Broker</code>上读取一个<code>command</code>，最后调用<code>TransportSupport#doConsume</code>消费消息。<br>整个过程调用链如下：</p>
<pre><code>ActiveMQConnectionFactory#createConnection -&gt; ActiveMQConnectionFactory#createActiveMQConnection -&gt; ServiceSupper#start -&gt; TcpTransport#doStart -&gt; TransportThreadSupport#doStart
-&gt; TcpTransport#run -&gt; TcpTransport#doRun -&gt; TransportSupport#doConsume -&gt; ActiveMQConnection#onCommand</code></pre><h3 id="ActiveMQConnection-onCommand"><a href="#ActiveMQConnection-onCommand" class="headerlink" title="ActiveMQConnection#onCommand"></a>ActiveMQConnection#onCommand</h3><p>该方法中所有消息都会调用<code>visit</code>方法，该方法接受一个<code>CommandVisitor</code>，针对不同的消息做不同的处理，代码如下：</p>
<pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">class</span> <span class="token class-name">ActiveMQConnection</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onCommand</span><span class="token punctuation">(</span><span class="token keyword">final</span> Object o<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">final</span> Command command <span class="token operator">=</span> <span class="token punctuation">(</span>Command<span class="token punctuation">)</span>o<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>closed<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> command <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                command<span class="token punctuation">.</span><span class="token function">visit</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">CommandVisitorAdapter</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token annotation punctuation">@Override</span>
                    <span class="token keyword">public</span> Response <span class="token function">processMessageDispatch</span><span class="token punctuation">(</span>MessageDispatch md<span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception <span class="token punctuation">{</span>
                        <span class="token function">waitForTransportInterruptionProcessingToComplete</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        ActiveMQDispatcher dispatcher <span class="token operator">=</span> dispatchers<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>md<span class="token punctuation">.</span><span class="token function">getConsumerId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>dispatcher <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            <span class="token comment" spellcheck="true">// Copy in case a embedded broker is dispatching via</span>
                            <span class="token comment" spellcheck="true">// vm://</span>
                            <span class="token comment" spellcheck="true">// md.getMessage() == null to signal end of queue</span>
                            <span class="token comment" spellcheck="true">// browse.</span>
                            Message msg <span class="token operator">=</span> md<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token keyword">if</span> <span class="token punctuation">(</span>msg <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                                msg <span class="token operator">=</span> msg<span class="token punctuation">.</span><span class="token function">copy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                                msg<span class="token punctuation">.</span><span class="token function">setReadOnlyBody</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                                msg<span class="token punctuation">.</span><span class="token function">setReadOnlyProperties</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                                msg<span class="token punctuation">.</span><span class="token function">setRedeliveryCounter</span><span class="token punctuation">(</span>md<span class="token punctuation">.</span><span class="token function">getRedeliveryCounter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                                msg<span class="token punctuation">.</span><span class="token function">setConnection</span><span class="token punctuation">(</span>ActiveMQConnection<span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                                msg<span class="token punctuation">.</span><span class="token function">setMemoryUsage</span><span class="token punctuation">(</span>null<span class="token punctuation">)</span><span class="token punctuation">;</span>
                                md<span class="token punctuation">.</span><span class="token function">setMessage</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token punctuation">}</span>
                            dispatcher<span class="token punctuation">.</span><span class="token function">dispatch</span><span class="token punctuation">(</span>md<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                            LOG<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"{} no dispatcher for {} in {}"</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">,</span> md<span class="token punctuation">,</span> dispatchers<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                        <span class="token keyword">return</span> null<span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>

                    <span class="token annotation punctuation">@Override</span>
                    <span class="token keyword">public</span> Response <span class="token function">processProducerAck</span><span class="token punctuation">(</span>ProducerAck pa<span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception <span class="token punctuation">{</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>pa <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> pa<span class="token punctuation">.</span><span class="token function">getProducerId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            ActiveMQMessageProducer producer <span class="token operator">=</span> producers<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>pa<span class="token punctuation">.</span><span class="token function">getProducerId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token keyword">if</span> <span class="token punctuation">(</span>producer <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                                producer<span class="token punctuation">.</span><span class="token function">onProducerAck</span><span class="token punctuation">(</span>pa<span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token punctuation">}</span>
                        <span class="token punctuation">}</span>
                        <span class="token keyword">return</span> null<span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>

                    <span class="token annotation punctuation">@Override</span>
                    <span class="token keyword">public</span> Response <span class="token function">processBrokerInfo</span><span class="token punctuation">(</span>BrokerInfo info<span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception <span class="token punctuation">{</span>
                        brokerInfo <span class="token operator">=</span> info<span class="token punctuation">;</span>
                        brokerInfoReceived<span class="token punctuation">.</span><span class="token function">countDown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        optimizeAcknowledge <span class="token operator">&amp;=</span> <span class="token operator">!</span>brokerInfo<span class="token punctuation">.</span><span class="token function">isFaultTolerantConfiguration</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token function">getBlobTransferPolicy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setBrokerUploadUrl</span><span class="token punctuation">(</span>info<span class="token punctuation">.</span><span class="token function">getBrokerUploadUrl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">return</span> null<span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>

                    <span class="token annotation punctuation">@Override</span>
                    <span class="token keyword">public</span> Response <span class="token function">processConnectionError</span><span class="token punctuation">(</span><span class="token keyword">final</span> ConnectionError error<span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception <span class="token punctuation">{</span>
                        executor<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Runnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            <span class="token annotation punctuation">@Override</span>
                            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                                <span class="token function">onAsyncException</span><span class="token punctuation">(</span>error<span class="token punctuation">.</span><span class="token function">getException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token punctuation">}</span>
                        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">return</span> null<span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>

                    <span class="token annotation punctuation">@Override</span>
                    <span class="token keyword">public</span> Response <span class="token function">processControlCommand</span><span class="token punctuation">(</span>ControlCommand command<span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception <span class="token punctuation">{</span>
                        <span class="token keyword">return</span> null<span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>

                    <span class="token annotation punctuation">@Override</span>
                    <span class="token keyword">public</span> Response <span class="token function">processConnectionControl</span><span class="token punctuation">(</span>ConnectionControl control<span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception <span class="token punctuation">{</span>
                        <span class="token function">onConnectionControl</span><span class="token punctuation">(</span><span class="token punctuation">(</span>ConnectionControl<span class="token punctuation">)</span>command<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">return</span> null<span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>

                    <span class="token annotation punctuation">@Override</span>
                    <span class="token keyword">public</span> Response <span class="token function">processConsumerControl</span><span class="token punctuation">(</span>ConsumerControl control<span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception <span class="token punctuation">{</span>
                        <span class="token function">onConsumerControl</span><span class="token punctuation">(</span><span class="token punctuation">(</span>ConsumerControl<span class="token punctuation">)</span>command<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">return</span> null<span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>

                    <span class="token annotation punctuation">@Override</span>
                    <span class="token keyword">public</span> Response <span class="token function">processWireFormat</span><span class="token punctuation">(</span>WireFormatInfo info<span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception <span class="token punctuation">{</span>
                        <span class="token function">onWireFormatInfo</span><span class="token punctuation">(</span><span class="token punctuation">(</span>WireFormatInfo<span class="token punctuation">)</span>command<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">return</span> null<span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">onClientInternalException</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">for</span> <span class="token punctuation">(</span>Iterator<span class="token operator">&lt;</span>TransportListener<span class="token operator">></span> iter <span class="token operator">=</span> transportListeners<span class="token punctuation">.</span><span class="token function">iterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> iter<span class="token punctuation">.</span><span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            TransportListener listener <span class="token operator">=</span> iter<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            listener<span class="token punctuation">.</span><span class="token function">onCommand</span><span class="token punctuation">(</span>command<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>如果传入的消息是<code>MessageDispatch</code>，则会调用<code>processMessageDispatch</code>方法，在该方法中最终会调用<code>ActiveMQMessageConsumer</code>中的<code>dispatch</code>方法，<code>unConsumedMessages</code>的值就是在该方法中<code>enqueue</code>的。</p>
<p>总结：消费者在启动的时候会创建一个线程不断的从客户端和<code>Broker</code>的<code>Socket</code>连接中读取数据，然后交给<code>TransportListener</code>（这里的实现是<code>ActiveMQConnection</code>）处理，<br>消息的消费其实是从一个未消费的消息通道<code>unConsumedMessages</code>里面拿的，拿消息之前会判断当前<code>unConsumedMessages</code>中是否存在未消费的消息，如果不存在消息并且<code>prefetchSize</code>等于0，<br>则向<code>Broker</code>发送一条<code>pullCommand</code>指令，然后调用<code>dequeue</code>方法（该方法会被阻塞知道拿到消息后返回），然后<code>Broker</code>会向客户端<code>push</code>指定条数（prefetchSize）的消息（这里是异步实现，消息会<br>被<code>Transport</code>线程读取，然后交给<code>ActiveMQConnection#onCommand</code>监听器分发消息，最终会把消息<code>enqueue</code>到<code>unConsumedMessages</code>中），当<code>unConsumedMessages</code>有消息过后，<code>dequeue</code>方法解除<br>阻塞，返回消息，然后执行消息确认过程。</p>
<h2 id="prefetchSize与optimizeAcknowledge"><a href="#prefetchSize与optimizeAcknowledge" class="headerlink" title="prefetchSize与optimizeAcknowledge"></a>prefetchSize与optimizeAcknowledge</h2><ul>
<li>prefetchSize:窗口机制（消息的批量拉取）<br>不同的类型的队列，prefetchSize 的默认值也是不一样的，如下：<ol>
<li>持久化队列和非持久化Queue（队列），prefetchSize默认值为1000；</li>
<li>持久化 topic ，prefetchSize 默认值为100；</li>
<li>非持久化消息，prefetchSize 默认值为 Short.MAX_VALUE -1</li>
</ol>
</li>
</ul>
<p>配置方式：</p>
<pre><code>Destination destination = session.createQueue(&quot;myQueue?consumer.prefetchSize=88&quot;);</code></pre><ul>
<li>optimizeAcknowledge:消息优化确认，优化ACK，只有<code>optimizeAcknowledge</code>为true时，<code>prefetchSize</code>和<code>optimizeAcknowledgeTimeout</code>才有意义。消息的批量确认，也是一种减少网络开销的一种手段，<br>如果我们不开启优化ACK，那么<code>Broker</code>push一批消息到客户端过后，客户端消费一条消息向<code>Broker</code>确认一次，<code>Broker</code>向客户端push一条消息，这样达不到批量的效果（假批量），所以一般情况下，这两个<br>配置是同事存在的，默认消息消费超过<code>65%</code>会发送一次批量确认（也就是1000*.65=650）。</li>
</ul>
<p>配置方式：</p>
<pre><code>ConnectionFactory connectionFactory= new ActiveMQConnectionFactory(&quot;tcp://localhost:61616?jms.optimizeAcknowledge=true&amp;jms.optimizeAcknowledgeTimeOut=10000&quot;);</code></pre><h2 id="消息的重发机制"><a href="#消息的重发机制" class="headerlink" title="消息的重发机制"></a>消息的重发机制</h2><p>正常情况下，触发消息重发的有两种情况</p>
<ul>
<li>事务性会话中，没有调用<code>session.commit</code>或者调用<code>session.rollback</code></li>
<li>非事务性会话中，没有调用<code>acknowledge</code>或者调用<code>recover</code></li>
</ul>
<p>一个消息被<code>redelivedred</code>超过6次，客户端会给<code>Broker</code>发送一个<code>poisonACK</code>，告诉<code>Broker</code>不要再重发消息了，然后<code>Broker</code>会将该条消息放入到DLQ（死信队列）中。</p>
<h2 id="死信队列"><a href="#死信队列" class="headerlink" title="死信队列"></a>死信队列</h2><p>ActiveMQ中默认的死信队列是<code>ActiveMQ.DLQ</code>，没有特殊的的配置，重发超过6次的消息都会被放到该队列中，默认情况下，如果持久消息过期后，也会被放到该死信队列中。<br>默认所有队列的死信队列都是<code>ActiveMQ.DLQ</code>，不便于管理，可以通过配置来针对某个队列配置特定的私信队列，配置如下：</p>
<pre class="line-numbers language-xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>destinationPolicy</span><span class="token punctuation">></span></span> 
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>policyMap</span><span class="token punctuation">></span></span> 
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>policyEntries</span><span class="token punctuation">></span></span> 
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>policyEntry</span> <span class="token attr-name">topic</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span><span class="token punctuation">></span><span class="token punctuation">"</span></span> <span class="token punctuation">></span></span> 
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>pendingMessageLimitStrategy</span><span class="token punctuation">></span></span> 
                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>constantPendingMessageLimitStrategy</span> <span class="token attr-name">limit</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>1000<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span> 
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>pendingMessageLimitStrategy</span><span class="token punctuation">></span></span> 
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>policyEntry</span><span class="token punctuation">></span></span>  
            <span class="token comment" spellcheck="true">&lt;!-->:表示对所有队列生效，指定队列直接写队列名称--></span> 
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>policyEntry</span> <span class="token attr-name">queue</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span><span class="token punctuation">></span><span class="token punctuation">"</span></span><span class="token punctuation">></span></span> 
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>deadLetterStrategy</span><span class="token punctuation">></span></span> 
                    <span class="token comment" spellcheck="true">&lt;!--queuePrefix:设置死信队列前缀--></span> 
                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>individualDeadLetterStrategy</span> <span class="token attr-name">queuePrefix</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>DLQ.<span class="token punctuation">"</span></span> <span class="token attr-name">useQueueForQueueMessages</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>true<span class="token punctuation">"</span></span> <span class="token attr-name">processExpired</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>false<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span> 
                    <span class="token comment" spellcheck="true">&lt;!--是否丢弃过期消息--></span>
                    <span class="token comment" spellcheck="true">&lt;!--&lt;sharedDeadLetterStrategy processExpired="false" />--></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>deadLetterStrategy</span><span class="token punctuation">></span></span> 
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>policyEntry</span><span class="token punctuation">></span></span> 
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>policyEntries</span><span class="token punctuation">></span></span> 
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>policyMap</span><span class="token punctuation">></span></span> 
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>destinationPolicy</span><span class="token punctuation">></span></span> <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="死信队列的再次消费"><a href="#死信队列的再次消费" class="headerlink" title="死信队列的再次消费"></a>死信队列的再次消费</h3><p>死信队列也是一个队列，在定位到问题原因过后，可以手动消费死信队列的消息。</p>
<h2 id="ActiveMQ静态网络配置"><a href="#ActiveMQ静态网络配置" class="headerlink" title="ActiveMQ静态网络配置"></a>ActiveMQ静态网络配置</h2><p>ActiveMQ支持使用网络配置的方式来达到集群的效果，ActiveMQ中的网络配置方式有两种，静态网络配置和动态网络配置。</p>
<ul>
<li>静态网络配置，配置方式如下</li>
</ul>
<pre class="line-numbers language-xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>networkConnectors</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>networkConnector</span> <span class="token attr-name">uri</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>static://(tcp://192.168.10.1:61616,tcp://192.168.10.2:61616)<span class="token punctuation">"</span></span> <span class="token attr-name">duplex</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>true<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>networkConnectors</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<ul>
<li>动态网络配置，该方式使用广播协议将其他的<code>Broker</code>连接起来，可以自动发现其他的<code>Broker</code>节点，这种方式替代了静态网络连接配置方式。</li>
</ul>
<p>消息回流：从5.6版本开始，ActiveMQ的网络配置方式集群支持消息回流，该功能解决了当<code>Broker1</code>上有需要转发的消息未消费时，将消息回流到原来的<code>Broker</code>上。需要配置如下：</p>
<pre class="line-numbers language-xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>policyEntry</span> <span class="token attr-name">queue</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span><span class="token punctuation">></span><span class="token punctuation">"</span></span> <span class="token attr-name">enableAudit</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>false<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>networkBridgeFilterFactory</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>conditionalNetworkBridgeFilterFactory</span> <span class="token attr-name">replayWhenNoConsumers</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>true<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>networkBridgeFilterFactory</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>policyEntry</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>配置消息回流需要配置<code>networkConnector</code>节点的<code>duplex</code>的属性为true。</p>
<h2 id="参考文献"><a href="#参考文献" class="headerlink" title="参考文献"></a>参考文献</h2><blockquote>
<p><a href="https://blog.csdn.net/lzb348110175/article/details/100132006" target="_blank" rel="noopener">https://blog.csdn.net/lzb348110175/article/details/100132006</a></p>
</blockquote>

            </div>
            <hr/>

            

            <link rel="stylesheet" type="text/css" href="/libs/share/css/share.min.css">

<div id="article-share">
    
    <div class="social-share" data-disabled="qzone" data-wechat-qrcode-helper="<p>微信里点“发现”->“扫一扫”二维码便可查看分享。</p>"></div>
    
</div>

<script src="/libs/share/js/social-share.min.js"></script>

            <div class="reprint">
                <p>
                    <span class="reprint-tip">
                        <i class="fa fa-exclamation-circle"></i>&nbsp;&nbsp;转载请注明:
                    </span>
                    <a href="http://blog.easyjava.xyz" class="b-link-green">James</a>
                    <i class="fa fa-angle-right fa-lg fa-fw text-color"></i>
                    <a href="/2019/11/30/ActiveMQ使用/" class="b-link-green">ActiveMQ使用</a>
                </p>
            </div>
        </div>
    </div>

    
        <link rel="stylesheet" href="/libs/gitalk/gitalk.css">
<link rel="stylesheet" href="/css/my-gitalk.css">

<div class="card gitalk-card" data-aos="fade-up">
    <div id="gitalk-container" class="card-content"></div>
</div>

<script src="/libs/gitalk/gitalk.min.js"></script>
<script>
    let gitalk = new Gitalk({
        clientID: 'a9858e7f3645ea83f878',
        clientSecret: '71d9c3a127b0215d02928dd47776ba2c72aad2cf',
        repo: 'james-ok.github.io',
        owner: 'james-ok',
        admin: "james-ok",
        id: '2019-11-30T10-09-29',
        distractionFreeMode: false  // Facebook-like distraction free mode
    });

    gitalk.render('gitalk-container');
</script>
    

    

    

    

    

    

<article id="prenext-posts" class="prev-next articles">
    <div class="row article-row">
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge left-badge text-color">
                <i class="fa fa-chevron-left"></i>&nbsp;上一篇</div>
            <div class="card">
                <a href="/2019/12/12/Kafka原理分析/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/17.jpg" class="responsive-img" alt="Kafka原理分析">
                        
                        <span class="card-title">Kafka原理分析</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary">我们都知道Kafka具有很高的吞吐量、数据分片、冗余和容错等优点，一般用于用户行为追踪以及分布式系统日志收集等场景，那么Kafka是如何做到这些优点的呢，今天就让我们来一一分析。
Kafka入门安装
点击下载
解压:tar -zxvf ka</div>
                    <div class="publish-info">
                        <span class="publish-date">
                            <i class="fa fa-clock-o fa-fw icon-date"></i>2019-12-12
                        </span>
                        <span class="publish-author">
                            
                            <i class="fa fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/Kafka/" class="post-category" target="_blank">
                                    Kafka
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/消息中间件/" target="_blank">
                        <span class="chip bg-color">消息中间件</span>
                    </a>
                    
                    <a href="/tags/Kafka/" target="_blank">
                        <span class="chip bg-color">Kafka</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge right-badge text-color">
                下一篇&nbsp;<i class="fa fa-chevron-right"></i>
            </div>
            <div class="card">
                <a href="/2019/11/21/Dubbo源码分析/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/7.jpg" class="responsive-img" alt="Dubbo源码分析">
                        
                        <span class="card-title">Dubbo源码分析</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary">Dubbo SPIDubbo SPI使用以及规范
创建接口并且加上@SPI注解表示该接口是一个Dubbo扩展点，将该扩展点打成一个jar包发布@SPI
public interface IHelloService {
  String sa</div>
                    <div class="publish-info">
                            <span class="publish-date">
                                <i class="fa fa-clock-o fa-fw icon-date"></i>2019-11-21
                            </span>
                        <span class="publish-author">
                            
                            <i class="fa fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/Dubbo/" class="post-category" target="_blank">
                                    Dubbo
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/SPI/" target="_blank">
                        <span class="chip bg-color">SPI</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
    </div>
</article>
</div>


<script>
    $('#articleContent').on('copy', function (e) {
        // IE8 or earlier browser is 'undefined'
        if (typeof window.getSelection === 'undefined') return;

        var selection = window.getSelection();
        // if the selection is short let's not annoy our users.
        if (('' + selection).length < Number.parseInt('120')) {
            return;
        }

        // create a div outside of the visible area and fill it with the selected text.
        var bodyElement = document.getElementsByTagName('body')[0];
        var newdiv = document.createElement('div');
        newdiv.style.position = 'absolute';
        newdiv.style.left = '-99999px';
        bodyElement.appendChild(newdiv);
        newdiv.appendChild(selection.getRangeAt(0).cloneContents());

        // we need a <pre> tag workaround.
        // otherwise the text inside "pre" loses all the line breaks!
        if (selection.getRangeAt(0).commonAncestorContainer.nodeName === 'PRE') {
            newdiv.innerHTML = "<pre>" + newdiv.innerHTML + "</pre>";
        }

        var url = document.location.href;
        newdiv.innerHTML += '<br />'
            + '来源: James<br />'
            + '作者: James<br />'
            + '链接: <a href="' + url + '">' + url + '</a><br />'
            + '本文章著作权归作者所有，任何形式的转载都请注明出处。';

        selection.selectAllChildren(newdiv);
        window.setTimeout(function () {bodyElement.removeChild(newdiv);}, 200);
    });
</script>

    </div>
    <div class="col l3 hide-on-med-and-down">
        <div class="toc-widget">
            <div class="toc-title"><i class="fa fa-list-alt"></i>&nbsp;&nbsp;目录</div>
            <div id="toc-content"></div>
        </div>
    </div>
</div>

<script src="/libs/tocbot/tocbot.min.js"></script>
<script>
    $(function () {
        tocbot.init({
            tocSelector: '#toc-content',
            contentSelector: '#articleContent',
            headingsOffset: -($(window).height() * 0.4 - 45),
            // headingsOffset: -205,
            headingSelector: 'h2, h3, h4'
        });

        // modify the toc link href to support Chinese.
        let i = 0;
        let tocHeading = 'toc-heading-';
        $('#toc-content a').each(function () {
            $(this).attr('href', '#' + tocHeading + (++i));
        });

        // modify the heading title id to support Chinese.
        i = 0;
        $('#articleContent').children('h2, h3, h4').each(function () {
            $(this).attr('id', tocHeading + (++i));
        });

        // Set scroll toc fixed.
        let tocHeight = parseInt($(window).height() * 0.4 - 64);
        let $tocWidget = $('.toc-widget');
        $(window).scroll(function () {
            let scroll = $(window).scrollTop();
            /* add post toc fixed. */
            if (scroll > tocHeight) {
                $tocWidget.addClass('toc-fixed');
            } else {
                $tocWidget.removeClass('toc-fixed');
            }
        });
    });
</script>
    

</main>


<footer class="page-footer bg-color">
    <div class="container row center-align">
        <div class="col s12 m8 l8 copy-right">
            本站由&copy;<a href="blog.easyjava.xyz" target="_blank">James</a>基于
            <a href="https://hexo.io/" target="_blank">Hexo</a> 的
            <a href="https://github.com/blinkfox/hexo-theme-matery" target="_blank">hexo-theme-matery</a>主题搭建.

            
                &nbsp;<i class="fa fa-area-chart"></i>&nbsp;站点总字数:&nbsp;
                <span class="white-color">50k</span>
            

            
			
                <br>
                
                <span id="busuanzi_container_site_pv">
                    <i class="fa fa-heart-o"></i>
                    本站总访问量 <span id="busuanzi_value_site_pv" class="white-color"></span>
                </span>
                
                
                <span id="busuanzi_container_site_uv">
                    <i class="fa fa-users"></i>
                    次,&nbsp;访客数 <span id="busuanzi_value_site_uv" class="white-color"></span> 人.
                </span>
                
            
        </div>
        <div class="col s12 m4 l4 social-link social-statis">
    <a href="https://github.com/james-ok" class="tooltipped" target="_blank" data-tooltip="访问我的GitHub" data-position="top" data-delay="50">
        <i class="fa fa-github"></i>
    </a>



    <a href="mailto:vip.dujuncheng@foxmail.com" class="tooltipped" target="_blank" data-tooltip="邮件联系我" data-position="top" data-delay="50">
        <i class="fa fa-envelope-open"></i>
    </a>



    <a href="tencent://AddContact/?fromId=50&fromSubId=1&subcmd=all&uin=1261100508" class="tooltipped" data-tooltip="QQ联系我: 1261100508" data-position="top" data-delay="50">
        <i class="fa fa-qq"></i>
    </a>


</div>
    </div>
</footer>

<div class="progress-bar"></div>


<!-- 搜索遮罩框 -->
<div id="searchModal" class="modal">
    <div class="modal-content">
        <div class="search-header">
            <span class="title"><i class="fa fa-search"></i>&nbsp;&nbsp;搜索</span>
            <input type="search" id="searchInput" name="s" placeholder="请输入搜索的关键字"
                   class="search-input" autofocus="">
        </div>
        <div id="searchResult"></div>
    </div>
</div>

<script src="/js/search.js"></script>
<script type="text/javascript">
    searchFunc("/" + "search.xml", 'searchInput', 'searchResult');
</script>
<!-- 回到顶部按钮 -->
<div id="backTop" class="top-scroll">
    <a class="btn-floating btn-large waves-effect waves-light" href="#!">
        <i class="fa fa-angle-up"></i>
    </a>
</div>


<script src="/libs/materialize/js/materialize.min.js"></script>
<script src="/libs/masonry/masonry.pkgd.min.js"></script>
<script src="/libs/aos/aos.js"></script>
<script src="/libs/scrollprogress/scrollProgress.min.js"></script>
<script src="/libs/lightGallery/js/lightgallery-all.min.js"></script>
<script src="/js/matery.js"></script>

<!-- Global site tag (gtag.js) - Google Analytics -->



    <script src="/libs/others/clicklove.js"></script>


    <script async src="/libs/others/busuanzi.pure.mini.js"></script>


</body>
</html>